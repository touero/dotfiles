#!/bin/bash
# @author touero
# @since 2025
# dm: Unexplained dmenu app launcher?

[[ -f "$HOME/.xprofile" ]] && source "$HOME/.xprofile"

has_chrome_in_current_ws() {
  local current_ws
  current_ws=$(swaymsg -t get_workspaces | jq -r '.[] | select(.focused==true).name')

  local has_chrome
  has_chrome=$(swaymsg -t get_tree | jq --arg ws "$current_ws" '
      .. | objects
      | select(.type=="workspace" and .name==$ws)
      | .. | objects
      | select(.type=="con" and .name != null)
      | select(.name | test("Chrome"))
      | .name
    ')

  if [[ -n "$has_chrome" ]]; then
    return 0
  else
    return 1
  fi
}

DMENU=(wmenu -i -f "Fira Code Nerd Font 30" -N 282828 -n ebdbb2 -m ebdbb2 -S fabd2f -s 282828 -l 10)
CHOICE=$(echo -e "bm\npw\nocr\ncud\ncrs\ncrsw\nhc\n" | "${DMENU[@]}")

BOOKMARK_FILE="$HOME/.config/bookmarks"

if [ -n "$WAYLAND_DISPLAY" ] && [ -n "$SWAYSOCK" ]; then
  CLIPBOARD="wl-copy"
elif [ -n "$XDG_SESSION_DESKTOP" ] && [[ "$XDG_SESSION_DESKTOP" == "gnome" ]]; then
  CLIPBOARD="wl-copy"
else
  CLIPBOARD="xclip -selection clipboard"
fi

case "$CHOICE" in
bm)
  [[ -f "$BOOKMARK_FILE" ]] || {
    echo "No bookmarks found"
    exit 1
  }

  SELECTED_BOOKMARK=$(cat "$BOOKMARK_FILE" | "${DMENU[@]}")
  if [[ -z "$SELECTED_BOOKMARK" ]]; then
    exit 0
  fi

  KEY=$(echo "$SELECTED_BOOKMARK" | cut -d'|' -f1)
  VALUE=$(echo "$SELECTED_BOOKMARK" | cut -d'|' -f2- | sed 's/^ *//;s/ *$//')

  if [[ "$VALUE" =~ ^https?:// ]]; then
    if has_chrome_in_current_ws; then
      xdg-open "$VALUE"
    else
      google-chrome --new-window "$VALUE"
    fi
  else
    echo "$VALUE" | $CLIPBOARD
  fi
  ;;
pw)
  echo -n "$DOCKER_PWD" | $CLIPBOARD
  ;;
ocr)
  "$HOME/.local/bin/ocr"
  ;;
cud)
  echo -n "$(date '+%Y_%m_%d*')" | $CLIPBOARD
  ;;
crs)
  grim -g "$(slurp)" - | ~/.local/bin/swappy -f -
  ;;
crsw)
  grim -g "$(swaymsg -t get_tree | jq -r '.. | select(.pid? and .visible?) | .rect | "\(.x),\(.y) \(.width)x\(.height)"' | slurp)" - | ~/.local/bin/swappy -f -
  ;;
hc)
  $HOME/.local/bin/hc
  ;;
*)
  exit 0
  ;;
esac
