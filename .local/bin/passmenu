#!/usr/bin/env bash
shopt -s nullglob globstar

if gpg-connect-agent "keyinfo --list" /bye | grep -q ' 1 '; then
  echo "gpg agent cache"
else
  if [ -t 0 ] && [ -t 1 ] && [ -t 2 ]; then
    echo test | gpg --clearsign >/dev/null
  else
    footclient \
      --app-id gpg-unlock \
      --title "GPG Unlock" \
      -e zsh -c 'export GPG_TTY=$(tty); gpg --sign </dev/null'
  fi

  if ! gpg-connect-agent "keyinfo --list" /bye | grep -q ' 1 '; then
    echo "verify not yet"
    notify-send "passmenu" "Error: verify not yet, exit passmenu"
    exit
  fi
fi

prefix=${PASSWORD_STORE_DIR:-$HOME/.password-store}
cd "$prefix" || {
  notify-send "passmenu" "Error: password store not found: $prefix"
  exit 1
}

mapfile -t password_files < <(
  find . -type f -name '*.gpg' -printf '%P\n' |
    sed 's/\.gpg$//'
)

((${#password_files[@]} == 0)) && {
  notify-send "passmenu" "No passwords found in $prefix"
  exit 1
}

lines=$((${#password_files[@]} < 10 ? ${#password_files[@]} : 10))

select_password=$(
  printf '%s\n' "${password_files[@]}" |
    "$HOME/.local/bin/menu" show -l $lines -p "pass"
)

[[ -z $select_password ]] && exit 0

password=$(pass show "$select_password" | head -n1)

source "$HOME/.local/bin/get_clipboard"
CLIPBOARD=$(get_clipboard)

printf '%s' "$password" | "$CLIPBOARD"
if command -v virkeys >/dev/null 2>&1; then
  focus_point
fi
