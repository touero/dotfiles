#!/usr/bin/env bash
# wttrcron: update current location weather
# @author touero
# @since 2025

WTTR="$HOME/.cache/wttr"
[ -f "$WTTR" ] || touch "$WTTR"

if [ ! -s "$WTTR" ] || [ $(($(date +%s) - $(stat -c %Y "$WTTR"))) -ge 3600 ]; then
  # Uncomment not in mainland China:
  # LOCATION=$(curl -s "https://api.myip.la/en?json" | jq -r '.location.city')
  # CITY=$(echo "$LOCATION" | sed 's/ /%20/g')
  LOCATION=$(curl -s "http://myip.ipip.net")
  CITY=$(echo "$LOCATION" | awk '{print $5}')

  WEATHER=""
  for i in {1..3}; do
    RAW=$(curl -s "wttr.in/$CITY?format=%c+%t+%w+%p+%P")
    WEATHER=$(echo "$RAW" | sed 's/  */ /g')

    if [[ -n "$(echo "$WEATHER" | tr -d '[:space:]')" && "$WEATHER" == *Â°C* ]]; then
      {
        echo "$WEATHER"
        echo "update time: $(date '+%Y-%m-%d %H:%M:%S')"
      } >"$WTTR"
      notify-send $WEATHER
      break
    fi
    sleep 2
  done
fi
