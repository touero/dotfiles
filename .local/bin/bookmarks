#!/usr/bin/env bash
# @author touero
# @since 2025
# bookmarks: Unexplained dmenu app launcher?

general_menu() {
  local file="$1"
  local prompt="$2"

  exist_file "$file"

  local DMENU=("$HOME/.local/bin/menu" show -l 20 -p "$prompt")
  local SELECTED=$("${DMENU[@]}" <"$file")
  [[ -z "$SELECTED" ]] && exit 0

  local VALUE="${SELECTED##*|}"
  VALUE="${VALUE#"${VALUE%%[![:space:]]*}"}"
  VALUE="${VALUE%"${VALUE##*[![:space:]]}"}"

  echo -n "$VALUE"
}
exist_file() {
  [[ -f "$1" ]] || {
    echo "No $1 file found"
    notify-send "bookmarks" "No $1 file found"
    exit 1
  }
}

has_browser_in_current_ws() {
  local current_ws
  current_ws=$(swaymsg -t get_workspaces | jq -r '.[] | select(.focused==true).name')

  local has_browser
  has_browser=$(swaymsg -t get_tree | jq --arg ws "$current_ws" '
      .. | objects
      | select(.type=="workspace" and .name==$ws)
      | .. | objects
      | select(.type=="con" and .name != null)
      | select(.name | test("Chrome|Chromium|Brave|[Ff]irefox|Edge"))
      | .name
    ')

  [[ -n "$has_browser" ]]
}

bookmarks() {
  local VALUE
  VALUE=$(general_menu "$1" "bookmarks") || exit 1
  [[ -z "$VALUE" ]] && exit 0
  DEFAULT_BROWSER="google-chrome"

  if [[ "$VALUE" =~ ^https?:// ]]; then
    if [[ "$2" == "cp" ]]; then
      echo -n "$VALUE" | wl-copy
      focus_point
    elif has_browser_in_current_ws; then
      $DEFAULT_BROWSER "$VALUE" &
    else
      $DEFAULT_BROWSER --new-window "$VALUE" &
    fi
  else
    echo -n "$VALUE" | wl-copy
    focus_point
  fi
}

contacts() {
  VALUE=$(general_menu "$1" "contacts") || exit 1
  [[ -z "$VALUE" ]] && exit 0
  echo -n "$VALUE" | wl-copy
  focus_point
}

BOOKMARKS="$HOME/.config/bookmarks"
CONTACTS="$HOME/.config/contacts"
case "$1" in
cp)
  bookmarks "$BOOKMARKS" "$1"
  ;;
contacts)
  contacts "$CONTACTS"
  ;;
*)
  bookmarks "$BOOKMARKS"
  ;;
esac
