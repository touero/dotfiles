#!/usr/bin/env bash
# @author touero
# @since 2025
# bookmarks: Unexplained dmenu app launcher?

BOOKMARK_FILE="$HOME/.config/bookmarks"
[[ -f "$BOOKMARK_FILE" ]] || {
  echo "No bookmarks found"
  exit 1
}

argp=""
if [[ "$1" == "cp" ]]; then
  argp="cp"
fi

DEFAULT_BROWSER="google-chrome"

has_browser_in_current_ws() {
  local current_ws
  current_ws=$(swaymsg -t get_workspaces | jq -r '.[] | select(.focused==true).name')

  local has_browser
  has_browser=$(swaymsg -t get_tree | jq --arg ws "$current_ws" '
      .. | objects
      | select(.type=="workspace" and .name==$ws)
      | .. | objects
      | select(.type=="con" and .name != null)
      | select(.name | test("Chrome|Chromium|Brave|[Ff]irefox|Edge"))
      | .name
    ')

  [[ -n "$has_browser" ]]
}

DMENU=("$HOME/.local/bin/menu" show -l 20 -p "bookmarks")

SELECTED_BOOKMARK=$("${DMENU[@]}" <"$BOOKMARK_FILE")
[[ -z "$SELECTED_BOOKMARK" ]] && exit 0

VALUE="${SELECTED_BOOKMARK##*|}"
VALUE="${VALUE#"${VALUE%%[![:space:]]*}"}"
VALUE="${VALUE%"${VALUE##*[![:space:]]}"}"

if [[ "$VALUE" =~ ^https?:// ]]; then
  if [[ "$argp" == "cp" ]]; then
    echo -n "$VALUE" | wl-copy
  elif has_browser_in_current_ws; then
    $DEFAULT_BROWSER "$VALUE" &
  else
    $DEFAULT_BROWSER --new-window "$VALUE" &
  fi
else
  echo -n "$VALUE" | wl-copy
fi
