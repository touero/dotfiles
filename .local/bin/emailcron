#!/usr/bin/env bash
# emailcron: update not read email count
# @author touero
# @since 2025

LOCK_FILE="$HOME/.cache/email.lock"
if [ -e "$LOCK_FILE" ]; then
  exit 0
fi

trap "rm -f '$LOCK_FILE'" EXIT
touch "$LOCK_FILE"

CACHE_FILE="$HOME/.cache/email"
[ -f "$CACHE_FILE" ] || touch "$CACHE_FILE"

update() {
  mbsync -a
  shopt -s globstar

  count=$(find "$HOME/Mail"/*/Inbox/new -type f | wc -l)
  {
    echo "$count"
    echo "check update: $(date '+%Y-%m-%d %H:%M:%S')"
  } >"$CACHE_FILE"

  pkill -RTMIN+1 waybar
  if [ "$count" == "0" ]; then
    exit 0
  fi
  notify-send "ó°‡® Update email from remote" "There are $count unread emails"
}

update
